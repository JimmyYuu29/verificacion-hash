# Hash Verification App Development Guide
# Guía de Desarrollo de la Aplicación de Verificación de Hash

## Project Overview / Resumen del Proyecto

This document describes the requirements and specifications for building a **Hash Verification Application** that can verify the authenticity and traceability of documents generated by the Carta de Manifestación Generator system.

Este documento describe los requisitos y especificaciones para construir una **Aplicación de Verificación de Hash** que pueda verificar la autenticidad y trazabilidad de documentos generados por el sistema Generador de Cartas de Manifestación.

---

## Purpose / Propósito

The Hash Verification App allows users to:
1. Input a hash code found at the footer of a PDF document
2. Retrieve complete information about the document's origin
3. Verify the document's authenticity and integrity
4. Access the original metadata used to generate the document

La Aplicación de Verificación de Hash permite a los usuarios:
1. Introducir un código hash encontrado en el pie de página de un documento PDF
2. Recuperar información completa sobre el origen del documento
3. Verificar la autenticidad e integridad del documento
4. Acceder a los metadatos originales utilizados para generar el documento

---

## Hash Code Format / Formato del Código Hash

Hash codes follow this format: `[TYPE_CODE]-[12_CHAR_HASH]`

Examples:
- `CM-A1B2C3D4E5F6` - Carta de Manifestación
- `IA-X9Y8Z7W6V5U4` - Informe de Auditoría
- `CE-Q1W2E3R4T5Y6` - Carta de Encargo
- `IR-M1N2B3V4C5X6` - Informe de Revisión
- `OT-P0O9I8U7Y6T5` - Otros Documentos

### Document Type Codes / Códigos de Tipo de Documento

| Code | Type | Description |
|------|------|-------------|
| CM | carta_manifestacion | Carta de manifestación de la dirección para auditoría |
| IA | informe_auditoria | Informe oficial de auditoría |
| CE | carta_encargo | Carta de encargo de auditoría |
| IR | informe_revision | Informe de revisión limitada |
| OT | otros | Otros documentos de auditoría |

---

## Data Storage Location / Ubicación de Almacenamiento de Datos

Metadata JSON files are stored in the following structure:

```
/output/
├── {username}/
│   ├── metadata_{hash_code}_{trace_id}.json
│   ├── metadata_{hash_code}_{trace_id}.json
│   └── ...
```

Each metadata file contains the complete record for document verification.

---

## Metadata JSON Structure / Estructura del JSON de Metadatos

```json
{
  "version": "1.0",
  "trace_id": "unique-uuid-trace-id",
  "hash_info": {
    "hash_code": "CM-A1B2C3D4E5F6",
    "algorithm": "SHA-256",
    "content_hash": "full_sha256_content_hash",
    "metadata_hash": "full_sha256_metadata_hash",
    "combined_hash": "full_sha256_combined_hash",
    "file_size": 45678
  },
  "document_info": {
    "type": "carta_manifestacion",
    "type_display": "Carta de Manifestación",
    "file_name": "Carta_Manifestacion_ClientName_20260121.docx",
    "creation_timestamp": "21/01/2026 14:30:45",
    "creation_timestamp_iso": "2026-01-21T14:30:45.123456"
  },
  "user_info": {
    "user_id": "username",
    "client_name": "Client Company Name"
  },
  "form_data": {
    "Nombre_Cliente": "Client Company Name",
    "Direccion_Oficina": "Office Address",
    "Fecha_de_hoy": "21/01/2026",
    // ... all form fields used to generate the document
  },
  "verification_instructions": {
    "es": "Para verificar este documento, use el código de hash en el verificador oficial de Forvis Mazars.",
    "en": "To verify this document, use the hash code in the official Forvis Mazars verifier."
  }
}
```

---

## Required Features / Funcionalidades Requeridas

### 1. Hash Code Input / Entrada de Código Hash

- Accept hash codes in format `XX-XXXXXXXXXXXX`
- Auto-detect document type from prefix
- Support both manual input and barcode/QR scanning (optional)
- Validate hash format before search

### 2. Search Functionality / Funcionalidad de Búsqueda

- Search through all metadata JSON files in the output directory
- Match by hash_code field
- Support partial hash matching (last 8 characters) with disambiguation
- Return "not found" with helpful message if no match

### 3. Results Display / Visualización de Resultados

When a hash is found, display:

**Document Information / Información del Documento:**
- Document type (with descriptive name)
- Original file name
- Creation date and time
- File size

**User Information / Información del Usuario:**
- User who generated the document
- Client name

**Hash Details / Detalles del Hash:**
- Full hash code
- Content hash (for integrity verification)
- Combined hash
- Algorithm used (SHA-256)

**Form Data / Datos del Formulario:**
- All original metadata fields used to generate the document
- Organized by sections (Office info, Client info, Dates, etc.)

### 4. Document Integrity Verification / Verificación de Integridad del Documento

If the user provides the original PDF file:
- Calculate content hash from uploaded file
- Compare with stored content_hash
- Display verification result (VALID / INVALID / MODIFIED)

### 5. Export Options / Opciones de Exportación

- Export verification report as PDF
- Export metadata as JSON
- Print verification certificate

---

## Technical Requirements / Requisitos Técnicos

### Recommended Stack / Stack Recomendado

**Backend:**
- Python 3.10+ with FastAPI
- File system access to read metadata JSON files
- hashlib for hash verification

**Frontend:**
- React, Vue.js, or simple HTML/CSS/JavaScript
- Responsive design for mobile access
- Dark/light mode support

**Alternative: Streamlit App**
- Single-file Python application
- Built-in file upload component
- Easy deployment

### API Endpoints / Endpoints de API

```
GET /api/verify/{hash_code}
  - Returns document metadata if found

POST /api/verify/integrity
  - Body: { hash_code: string, file: binary }
  - Returns integrity verification result

GET /api/search?q={partial_hash}
  - Returns list of matching documents

GET /api/stats
  - Returns statistics (total documents, by type, by user, etc.)
```

### Security Considerations / Consideraciones de Seguridad

1. **Read-only access** - App should only read metadata files, never modify
2. **Authentication** - Consider requiring login for sensitive information
3. **Rate limiting** - Prevent brute-force hash enumeration
4. **Audit logging** - Log all verification attempts
5. **Data masking** - Option to hide sensitive form_data fields

---

## User Interface Mockup / Diseño de Interfaz de Usuario

### Main Search View / Vista Principal de Búsqueda

```
┌─────────────────────────────────────────────────────────────┐
│  FORVIS MAZARS - Document Hash Verifier                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Enter Hash Code:                                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ CM-A1B2C3D4E5F6                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [VERIFY] [UPLOAD PDF FOR INTEGRITY CHECK]                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Results View / Vista de Resultados

```
┌─────────────────────────────────────────────────────────────┐
│  ✓ DOCUMENT FOUND                                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Document Type: Carta de Manifestación                      │
│  Hash Code: CM-A1B2C3D4E5F6                                 │
│  Created: 21/01/2026 14:30:45                               │
│  User: juan.perez                                           │
│  Client: Empresa ABC S.L.                                   │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  FORM DATA USED:                                            │
│                                                             │
│  Office Information:                                        │
│    - Address: Calle Example 123                             │
│    - City: Madrid                                           │
│    - Postal Code: 28001                                     │
│                                                             │
│  Client Information:                                        │
│    - Name: Empresa ABC S.L.                                 │
│                                                             │
│  Dates:                                                     │
│    - Document Date: 21/01/2026                              │
│    - Fiscal Year End: 31/12/2025                            │
│                                                             │
│  [DOWNLOAD VERIFICATION CERTIFICATE] [EXPORT JSON]          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Implementation Steps / Pasos de Implementación

### Phase 1: Core Verification / Fase 1: Verificación Básica

1. Create file scanner to index all metadata JSON files
2. Implement hash code search function
3. Build basic API endpoint for verification
4. Create simple web interface for hash input

### Phase 2: Enhanced Features / Fase 2: Funciones Avanzadas

1. Add PDF upload for integrity verification
2. Implement content hash comparison
3. Add export/print functionality
4. Create verification certificate generator

### Phase 3: Administration / Fase 3: Administración

1. Build statistics dashboard
2. Add audit logging
3. Implement user authentication
4. Create admin panel for monitoring

### Phase 4: Integration / Fase 4: Integración

1. API documentation (OpenAPI/Swagger)
2. Integration with existing Forvis Mazars systems
3. Mobile-responsive design
4. QR code scanning support

---

## Sample Code / Código de Ejemplo

### Python: Hash Search Function / Función de Búsqueda de Hash

```python
import json
from pathlib import Path
from typing import Optional, Dict, Any, List

def search_by_hash(hash_code: str, output_dir: Path) -> Optional[Dict[str, Any]]:
    """
    Search for document metadata by hash code.

    Args:
        hash_code: The hash code to search for (e.g., "CM-A1B2C3D4E5F6")
        output_dir: Path to the output directory containing user folders

    Returns:
        Metadata dictionary if found, None otherwise
    """
    # Search through all user directories
    for user_dir in output_dir.iterdir():
        if not user_dir.is_dir():
            continue

        # Search through all metadata files in user directory
        for metadata_file in user_dir.glob("metadata_*.json"):
            try:
                with open(metadata_file, "r", encoding="utf-8") as f:
                    metadata = json.load(f)

                if metadata.get("hash_info", {}).get("hash_code") == hash_code:
                    return metadata
            except (json.JSONDecodeError, IOError):
                continue

    return None


def verify_document_integrity(
    hash_code: str,
    pdf_content: bytes,
    output_dir: Path
) -> Dict[str, Any]:
    """
    Verify document integrity by comparing hashes.

    Args:
        hash_code: The hash code to verify
        pdf_content: Binary content of the PDF file
        output_dir: Path to the output directory

    Returns:
        Verification result dictionary
    """
    import hashlib

    # Find the metadata
    metadata = search_by_hash(hash_code, output_dir)
    if not metadata:
        return {"valid": False, "error": "Hash code not found"}

    # Calculate hash of provided PDF
    calculated_hash = hashlib.sha256(pdf_content).hexdigest()
    stored_hash = metadata.get("hash_info", {}).get("content_hash")

    is_valid = calculated_hash.lower() == stored_hash.lower()

    return {
        "valid": is_valid,
        "hash_code": hash_code,
        "calculated_hash": calculated_hash,
        "stored_hash": stored_hash,
        "message": "Document is authentic" if is_valid else "Document has been modified"
    }
```

### FastAPI Endpoint Example / Ejemplo de Endpoint FastAPI

```python
from fastapi import FastAPI, HTTPException, UploadFile, File
from pathlib import Path

app = FastAPI(title="Hash Verifier API")
OUTPUT_DIR = Path("./output")

@app.get("/api/verify/{hash_code}")
async def verify_hash(hash_code: str):
    """Verify a hash code and return document metadata."""
    metadata = search_by_hash(hash_code, OUTPUT_DIR)

    if not metadata:
        raise HTTPException(status_code=404, detail="Hash code not found")

    return {
        "success": True,
        "metadata": metadata
    }

@app.post("/api/verify/integrity")
async def verify_integrity(hash_code: str, file: UploadFile = File(...)):
    """Verify document integrity with uploaded PDF."""
    content = await file.read()
    result = verify_document_integrity(hash_code, content, OUTPUT_DIR)
    return result
```

---

## Deployment Recommendations / Recomendaciones de Despliegue

### Docker Deployment / Despliegue con Docker

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# Mount the output directory with metadata files
VOLUME ["/app/output"]

EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Environment Variables / Variables de Entorno

```bash
# Required
OUTPUT_DIR=/path/to/output/directory
SECRET_KEY=your-secret-key-for-sessions

# Optional
LOG_LEVEL=INFO
RATE_LIMIT=100/minute
ENABLE_AUDIT_LOG=true
```

---

## Testing Checklist / Lista de Verificación de Pruebas

- [ ] Hash code format validation
- [ ] Search functionality with valid hash
- [ ] Search functionality with invalid hash
- [ ] Partial hash matching
- [ ] PDF integrity verification (valid document)
- [ ] PDF integrity verification (modified document)
- [ ] Export functionality
- [ ] Mobile responsive design
- [ ] Performance with large number of metadata files
- [ ] Security: SQL injection prevention
- [ ] Security: Path traversal prevention
- [ ] Rate limiting functionality

---

## Contact / Contacto

For questions about this implementation guide or the existing document generation system, contact the development team.

Para preguntas sobre esta guía de implementación o el sistema existente de generación de documentos, contacte al equipo de desarrollo.

---

*Document Version: 1.0*
*Last Updated: 2026-01-21*
*Compatible with: Carta de Manifestación Generator v1.1.0*
